FROM node:20-bullseye-slim AS build
WORKDIR /app
RUN corepack enable
ENV YARN_ENABLE_GLOBAL_CACHE=false \
    YARN_CACHE_FOLDER=/tmp/.yarn-cache
COPY app/package.json app/yarn.lock app/.yarnrc.yml app/.yarn/ ./
RUN yarn install --immutable
COPY app/ ./
RUN yarn build

FROM node:20-bullseye-slim AS runner
WORKDIR /app
RUN useradd -m -u 10001 appuser
COPY --from=build /app ./
ENV NODE_ENV=production \
    AFFINE_SERVER_PORT=3010
EXPOSE 3010
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD node -e "http=require('http');r=http.request({host:'127.0.0.1',port:process.env.AFFINE_SERVER_PORT,path:'/'},res=>{process.exit(res.statusCode>=200&&res.statusCode<400?0:1)});r.on('error',()=>process.exit(1));r.end()"
USER 10001
CMD ["bash", "-lc", "yarn run -T start || node server.js"]
