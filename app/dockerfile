# ---------- Builder ----------
    FROM node:20-alpine AS builder
    WORKDIR /app
    
    # Enable Corepack (to use Yarn 4.9.1 from packageManager field)
    RUN corepack enable && corepack prepare yarn@4.9.1 --activate
    
    # Copy repo (including git for versioning if needed)
    COPY .git .git
    COPY . .
    
    # Install dependencies
    RUN yarn install --immutable
    
    # Build the web workspace
    WORKDIR /app/packages/frontend/apps/web
    RUN yarn build || (echo "Build failed" && exit 1)
    
    # Debug: show what got built
    RUN echo "--- After build, contents of web dir ---" && ls -lah && \
        echo "--- dist ---" && ls -lah dist || true && \
        echo "--- .next ---" && ls -lah .next || true
    
    # ---------- Runner ----------
    FROM node:20-alpine AS runner
    WORKDIR /app
    
    # Copy built web app from builder
    COPY --from=builder /app/packages/frontend/apps/web ./packages/frontend/apps/web
    COPY --from=builder /app/node_modules ./node_modules
    COPY --from=builder /app/package.json ./package.json
    
    EXPOSE 3000
    
    # Default command (adjust depending on framework)
    CMD ["yarn", "workspace", "@affine/web", "start"]
    